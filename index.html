<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fleet Ops</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* General Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Helvetica, Arial, sans-serif;
      background-color: #f4f4f4;
      color: #333;
    }

    header {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 10px 20px;
      background-color: #000;
      color: #fff;
    }

    header h1 {
      font-size: 1.05rem; /* Reduced by 30% */
    }

    #map {
      height: 50vh;
      width: 100%;
    }

    .details-section {
      padding: 20px;
      background-color: #fff;
      overflow-y: auto;
      position: relative;
    }

    .details-section h2 {
      margin-bottom: 10px;
    }

    .details-section ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .details-section li {
      padding: 10px;
      background: #f9f9f9;
      margin-bottom: 5px;
      border-radius: 5px;
      border: 1px solid #ddd;
    }

    .details-section .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .details-section button {
      padding: 10px 15px;
      font-size: 1rem;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .lock-btn {
      background-color: #ff4d4d; /* Uber red */
    }

    .unlock-btn {
      background-color: #4caf50; /* Uber green */
    }

    button:hover {
      opacity: 0.9;
    }

    /* Container for 3D Model */
    .model-container {
      width: 100%;
      height: 0;
      padding-bottom: 30%; /* Aspect ratio of 0.3 */
      position: relative;
      margin-bottom: 20px;
    }

    .model-container iframe {
      position: absolute;
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Position the dropdown over the 3D model */
    .dropdown-over-model {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1000;
    }

    .dropdown-over-model select {
      padding: 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 300px;
    }
  </style>
  <!-- Replace 'YOUR_GOOGLE_MAPS_API_KEY' with your actual Google Maps API key -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8rDrxBzMRlgbA7BQ2DoY31gEXzZ4Ours"></script>
</head>
<body>
  <header>
    <h1>Fleet Ops</h1>
  </header>

  <div id="map"></div>

  <!-- Dropdown over the 3D model -->
  <div class="dropdown-over-model">
    <select id="vehicleSelector">
      <option value="">-- Loading Vehicles --</option>
    </select>
  </div>

  <div class="details-section">
    <h2>Vehicle Details</h2>
    <div class="model-container">
      <!-- Embed Sketchfab 3D Model -->
      <div class="sketchfab-embed-wrapper">
        <iframe title="mtc" frameborder="0" allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true" allow="autoplay; fullscreen; xr-spatial-tracking" xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share width="640" height="480" src="https://sketchfab.com/models/2c530666fa834f71b75f526f1bb1eb40/embed?autostart=1&camera=0&ui_animations=0&ui_infos=0&ui_stop=0&ui_inspector=0&ui_watermark_link=0&ui_watermark=0&ui_ar=0&ui_help=0&ui_settings=0&ui_vr=0&ui_fullscreen=0&ui_annotations=0"></iframe>
      </div>
    </div>
    <ul id="vehicleDetails">
      <li>Select a vehicle to see details here...</li>
    </ul>
    <div class="button-group">
      <button id="lockButton" class="lock-btn" disabled>Lock</button>
      <button id="unlockButton" class="unlock-btn" disabled>Unlock</button>
    </div>
  </div>

  <script>
    const username = 'URBA00001';
    const token = 'fd58cd26fefc8c2b2ba1f7f52b33221a65f645790a43ff9b8da35db7da6e1f33';
    const auth = btoa(`${username}:${token}`);
    const baseUrl = 'https://fleetapi-hk.cartrack.com/rest';

    let map;
    let markers = {};
    let selectedVehicle = null;

    // Initialize Google Map with dark theme and remove controls
    function initMap() {
      const darkMapStyle = [
        // Dark theme style JSON
        {
          "elementType": "geometry",
          "stylers": [{ "color": "#212121" }]
        },
        {
          "elementType": "labels.icon",
          "stylers": [{ "visibility": "off" }]
        },
        {
          "elementType": "labels.text.fill",
          "stylers": [{ "color": "#757575" }]
        },
        {
          "elementType": "labels.text.stroke",
          "stylers": [{ "color": "#212121" }]
        },
        // ... Additional style rules
      ];

      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 22.3193, lng: 114.1694 }, // Default center (Hong Kong)
        zoom: 12,
        styles: darkMapStyle,
        streetViewControl: false,
        mapTypeControl: false,
      });
    }

    // Fetch vehicles from Cartrack API
    async function fetchVehicles() {
      try {
        const response = await fetch(`${baseUrl}/vehicles`, {
          method: 'GET',
          headers: {
            'Authorization': `Basic ${auth}`,
            'Content-Type': 'application/json',
          },
        });

        if (!response.ok) throw new Error(`Error: ${response.status}`);
        const data = await response.json();

        // Use the correct identifier (e.g., vehicle ID)
        const vehiclesWithDetails = await Promise.all(data.data.map(async (vehicle) => {
          const location = await fetchVehicleLocation(vehicle.id); // Using vehicle.id
          const doorStatus = await fetchDoorStatus(vehicle.id);
          return { ...vehicle, location, doorStatus };
        }));

        populateDropdown(vehiclesWithDetails);
        plotVehiclesOnMap(vehiclesWithDetails);
      } catch (error) {
        console.error("Failed to fetch vehicles:", error);
      }
    }

    // Fetch vehicle location
    async function fetchVehicleLocation(vehicleId) {
      try {
        const response = await fetch(`${baseUrl}/vehicles/${vehicleId}/location`, {
          method: 'GET',
          headers: {
            'Authorization': `Basic ${auth}`,
            'Content-Type': 'application/json',
          },
        });

        if (!response.ok) throw new Error(`Error: ${response.status}`);
        const data = await response.json();
        return data.data; // Adjusted based on API response
      } catch (error) {
        console.error(`Failed to fetch location for vehicle ${vehicleId}:`, error);
        return null;
      }
    }

    // Fetch door status
    async function fetchDoorStatus(vehicleId) {
      try {
        const response = await fetch(`${baseUrl}/vehicles/${vehicleId}/doorstatus`, {
          method: 'GET',
          headers: {
            'Authorization': `Basic ${auth}`,
            'Content-Type': 'application/json',
          },
        });

        if (!response.ok) throw new Error(`Error: ${response.status}`);
        const data = await response.json();
        return data.data.doorStatus; // Adjusted based on API response
      } catch (error) {
        console.error(`Failed to fetch door status for vehicle ${vehicleId}:`, error);
        return 'Unknown';
      }
    }

    // Populate Dropdown
    function populateDropdown(vehicles) {
      const selector = document.getElementById('vehicleSelector');
      selector.innerHTML = `<option value="">-- Select a Vehicle --</option>`;
      vehicles.forEach(vehicle => {
        const option = document.createElement('option');
        option.value = vehicle.id; // Using vehicle.id
        option.textContent = `${vehicle.registration} (${vehicle.model})`;
        selector.appendChild(option);
      });

      selector.addEventListener('change', () => {
        const selectedVehicleId = selector.value;
        if (selectedVehicleId) {
          selectedVehicle = vehicles.find(v => v.id == selectedVehicleId);
          displayVehicleDetails(selectedVehicle);
          updateMapMarkers(selectedVehicle);
        } else {
          selectedVehicle = null;
          document.getElementById('lockButton').disabled = true;
          document.getElementById('unlockButton').disabled = true;
          // Show all markers
          for (let id in markers) {
            markers[id].setVisible(true);
          }
          map.setZoom(12);
          map.setCenter({ lat: 22.3193, lng: 114.1694 });
        }
      });
    }

    // Plot Vehicles on Map
    function plotVehiclesOnMap(vehicles) {
      // Clear existing markers
      for (let id in markers) {
        markers[id].setMap(null);
      }
      markers = {};

      vehicles.forEach(vehicle => {
        if (vehicle.location) {
          const marker = new google.maps.Marker({
            position: { lat: vehicle.location.latitude, lng: vehicle.location.longitude },
            map,
            title: vehicle.registration,
          });
          markers[vehicle.id] = marker;
        }
      });
    }

    // Update Map Markers based on selection
    function updateMapMarkers(selectedVehicle) {
      for (let id in markers) {
        if (id == selectedVehicle.id) {
          markers[id].setVisible(true);
          map.setCenter(markers[id].getPosition());
          map.setZoom(18); // Street level zoom
        } else {
          markers[id].setVisible(false);
        }
      }
    }

    // Display Selected Vehicle Details
    function displayVehicleDetails(vehicle) {
      const detailsList = document.getElementById('vehicleDetails');
      detailsList.innerHTML = `
        <li><strong>Registration:</strong> ${vehicle.registration}</li>
        <li><strong>Model:</strong> ${vehicle.model}</li>
        <li><strong>Door Status:</strong> ${vehicle.doorStatus}</li>
        <li><strong>Last Known Location:</strong> ${vehicle.location 
          ? \`Lat: \${vehicle.location.latitude}, Lng: \${vehicle.location.longitude}\` 
          : 'Unavailable'}
        </li>
      `;

      document.getElementById('lockButton').disabled = false;
      document.getElementById('unlockButton').disabled = false;
    }

    // Send Lock/Unlock Command
    async function sendCommand(vehicle, command) {
      try {
        const response = await fetch(`${baseUrl}/vehicles/${vehicle.id}/commands`, {
          method: 'POST',
          headers: {
            'Authorization': `Basic ${auth}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ command }),
        });

        if (!response.ok) throw new Error(`Error: ${response.status}`);
        alert(`Command '${command}' sent to vehicle ${vehicle.registration}.`);

        // Update door status after command
        vehicle.doorStatus = command === 'LOCK' ? 'Locked' : 'Unlocked';
        displayVehicleDetails(vehicle);
      } catch (error) {
        console.error(`Failed to send '${command}' command:`, error);
        alert(`Failed to send '${command}' command.`);
      }
    }

    // Event Listeners for Lock and Unlock Buttons
    document.getElementById('lockButton').addEventListener('click', () => {
      if (selectedVehicle) sendCommand(selectedVehicle, 'LOCK');
    });

    document.getElementById('unlockButton').addEventListener('click', () => {
      if (selectedVehicle) sendCommand(selectedVehicle, 'UNLOCK');
    });

    // Initialize map and fetch data on page load
    window.onload = () => {
      initMap();
      fetchVehicles();
    };
  </script>
</body>
</html>
