<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fleet Ops</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* General Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Helvetica, Arial, sans-serif;
      background-color: #121212; /* Dark background to complement dark map */
      color: #fff;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: center; /* Center the dropdown */
      padding: 2px 20px; /* 2px padding on top and bottom */
      background-color: #1e1e1e; /* Slightly lighter dark for header */
      position: relative;
      height: 60px; /* Adjust height to accommodate dropdown */
    }

    header img {
      height: 40px;
      margin-right: 10px;
      position: absolute;
      left: 20px;
    }

    header h1 {
      font-size: 0.735rem; /* 1.05rem reduced by 30% */
      text-align: right;
      position: absolute;
      right: 20px;
    }

    #map {
      height: 50vh;
      width: 100%;
    }

    .details-section {
      padding: 20px;
      background-color: #1e1e1e;
      overflow-y: auto;
    }

    .details-section h2 {
      margin-bottom: 10px;
    }

    .details-section ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .details-section li {
      padding: 10px;
      background: #2c2c2c;
      margin-bottom: 5px;
      border-radius: 5px;
      border: 1px solid #444;
    }

    .details-section .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .details-section button {
      padding: 10px 15px;
      font-size: 1rem;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .lock-btn {
      background-color: #ff4d4d; /* Uber red */
    }

    .unlock-btn {
      background-color: #4caf50; /* Uber green */
    }

    .horn-btn {
      background-color: #ffc107; /* Amber color for horn button */
    }

    button:hover {
      opacity: 0.9;
    }

    /* Container for 3D Model */
    .model-container {
      width: 100%;
      height: 0;
      padding-bottom: 30%; /* Aspect ratio of 0.3 */
      position: relative;
      margin-bottom: 20px;
    }

    .model-container iframe {
      position: absolute;
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
  <!-- Replace 'YOUR_GOOGLE_MAPS_API_KEY' with your actual Google Maps API key -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8rDrxBzMRlgbA7BQ2DoY31gEXzZ4Ours"></script>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo">
    <div class="dropdown-container">
      <select id="vehicleSelector">
        <option value="">-- Loading Vehicles --</option>
      </select>
    </div>
    <h1>Fleet Ops</h1>
  </header>

  <div id="map"></div>

  <div class="details-section">
    <h2>Vehicle Details</h2>
    <div class="model-container">
      <!-- Embed Sketchfab 3D Model -->
      <div class="sketchfab-embed-wrapper">
        <iframe title="mtc" frameborder="0" allowfullscreen mozallowfullscreen="true"
          webkitallowfullscreen="true" allow="autoplay; fullscreen; xr-spatial-tracking"
          xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share
          width="640" height="480"
          src="https://sketchfab.com/models/2c530666fa834f71b75f526f1bb1eb40/embed?autostart=1&camera=0&ui_animations=0&ui_infos=0&ui_stop=0&ui_inspector=0&ui_watermark_link=0&ui_watermark=0&ui_ar=0&ui_help=0&ui_settings=0&ui_vr=0&ui_fullscreen=0&ui_annotations=0">
        </iframe>
      </div>
    </div>
    <ul id="vehicleDetails">
      <li>Select a vehicle to see details here...</li>
    </ul>
    <div class="button-group">
      <button id="lockButton" class="lock-btn" disabled>Lock</button>
      <button id="unlockButton" class="unlock-btn" disabled>Unlock</button>
      <!-- If you have a horn function, you can include it -->
      <!-- <button id="hornButton" class="horn-btn" disabled>Horn</button> -->
    </div>
  </div>

  <script>
    // Configuration
    const username = 'URBA00001'; // Replace with your username
    const token = 'fd58cd26fefc8c2b2ba1f7f52b33221a65f645790a43ff9b8da35db7da6e1f33';       // Replace with your token
    const auth = btoa(`${username}:${token}`);
    const baseUrl = 'https://fleetapi-hk.cartrack.com/rest';

    let map;
    let markers = {};
    let selectedVehicle = null;
    let vehicles = [];

    // Initialize Google Map with dark theme and remove controls
    function initMap() {
      const darkMapStyle = [
        {
          "elementType": "geometry",
          "stylers": [{"color": "#242f3e"}]
        },
        {
          "elementType": "labels.text.stroke",
          "stylers": [{"color": "#242f3e"}]
        },
        {
          "elementType": "labels.text.fill",
          "stylers": [{"color": "#746855"}]
        },
        // Add more styles as needed
      ];

      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 22.3193, lng: 114.1694 }, // Default center (Hong Kong)
        zoom: 12,
        styles: darkMapStyle,
        streetViewControl: false,
        mapTypeControl: false,
      });
    }

    // API Functions (extracted from your provided code)

    // Create request options
    function createRequestOptions(method, contentType = null, body = null) {
      let myHeaders = new Headers();
      myHeaders.append("Authorization", `Basic ${auth}`);
      if (contentType) {
        myHeaders.append("Content-Type", contentType);
      }
      let requestOptions = {
        method: method,
        headers: myHeaders,
        redirect: "follow",
      };
      if (body) {
        requestOptions.body = JSON.stringify(body);
      }
      return requestOptions;
    }

    // Get the list of vehicles
    async function getCars() {
      try {
        let url = `${baseUrl}/vehicles?limit=10000`;
        const requestOptions = createRequestOptions("GET", 'application/json');
        let response = await fetch(url, requestOptions);
        response = await response.json();
        return response;
      } catch (error) {
        console.error("Error fetching vehicles:", error);
        return null;
      }
    }

    // Get the status of a specific car
    async function getCarStatus(registration) {
      try {
        let url = `${baseUrl}/vehicles/status?filter[registration]=${encodeURIComponent(registration)}`;
        const requestOptions = createRequestOptions("GET");
        let response = await fetch(url, requestOptions);
        response = await response.json();
        if (response?.data?.length) {
          return response.data[0];
        } else {
          console.warn(`No status data found for vehicle ${registration}.`);
          return null;
        }
      } catch (error) {
        console.error(`Error fetching status for vehicle ${registration}:`, error);
        return null;
      }
    }

    // Command car (lock/unlock)
    async function commandCar(registration, commandType) {
      try {
        let url = `${baseUrl}/vehicles/${encodeURIComponent(registration)}/central-locking`;
        const requestOptions = createRequestOptions("PUT", 'application/json', { command: commandType });
        let response = await fetch(url, requestOptions);
        response = await response.json();
        alert(`Command '${commandType}' sent to vehicle ${registration}.`);
        return response;
      } catch (error) {
        console.error(`Error sending command to vehicle ${registration}:`, error);
        alert(`Failed to send '${commandType}' command.`);
        return null;
      }
    }

    // Fetch vehicles and populate dropdown
    async function fetchVehicles() {
      const data = await getCars();
      if (data && Array.isArray(data.data)) {
        vehicles = data.data;
        populateDropdown(vehicles);
        await plotVehiclesOnMap(vehicles);
      } else {
        console.error("Invalid vehicle data received.");
      }
    }

    // Populate Dropdown
    function populateDropdown(vehicles) {
      const selector = document.getElementById('vehicleSelector');
      selector.innerHTML = `<option value="">-- Select a Vehicle --</option>`;
      vehicles.forEach(vehicle => {
        const option = document.createElement('option');
        option.value = vehicle.registration; // Using registration
        option.textContent = `${vehicle.registration} (${vehicle.model})`;
        selector.appendChild(option);
      });

      selector.addEventListener('change', async () => {
        const selectedRegistration = selector.value;
        if (selectedRegistration) {
          selectedVehicle = vehicles.find(v => v.registration === selectedRegistration);
          const status = await getCarStatus(selectedVehicle.registration);
          if (status) {
            selectedVehicle.location = {
              latitude: status.location.latitude,
              longitude: status.location.longitude,
            };
            selectedVehicle.doorStatus = status.door_status;
            selectedVehicle.batteryLevel = status.battery_level;
            selectedVehicle.systemStatus = status.system_status;
            selectedVehicle.lastActiveTime = status.last_active_time;
          }
          displayVehicleDetails(selectedVehicle);
          updateMapMarkers(selectedVehicle);
        } else {
          selectedVehicle = null;
          document.getElementById('lockButton').disabled = true;
          document.getElementById('unlockButton').disabled = true;
          // Show all markers
          for (let reg in markers) {
            markers[reg].setVisible(true);
          }
          map.setZoom(12);
          map.setCenter({ lat: 22.3193, lng: 114.1694 });
        }
      });
    }

    // Plot Vehicles on Map
    async function plotVehiclesOnMap(vehicles) {
      // Clear existing markers
      for (let reg in markers) {
        markers[reg].setMap(null);
      }
      markers = {};

      // Fetch status for all vehicles
      const statusResponse = await getCarsStatus(vehicles.map(v => v.registration));
      if (statusResponse && Array.isArray(statusResponse)) {
        vehicles.forEach(vehicle => {
          const status = statusResponse.find(s => s.registration === vehicle.registration);
          if (status && status.location) {
            vehicle.location = {
              latitude: status.location.latitude,
              longitude: status.location.longitude,
            };

            const marker = new google.maps.Marker({
              position: { lat: vehicle.location.latitude, lng: vehicle.location.longitude },
              map,
              title: vehicle.registration,
            });
            markers[vehicle.registration] = marker;
          } else {
            console.warn(`No location data for vehicle ${vehicle.registration}.`);
          }
        });
      } else {
        console.error("Invalid status data received.");
      }
    }

    // Get statuses for multiple vehicles
    async function getCarsStatus(registrations) {
      try {
        let url = `${baseUrl}/vehicles/status?limit=10000`;
        const requestOptions = createRequestOptions("GET");
        let response = await fetch(url, requestOptions);
        response = await response.json();
        if (response?.data) {
          return response.data.filter(item => registrations.includes(item.registration));
        } else {
          return [];
        }
      } catch (error) {
        console.error("Error fetching vehicle statuses:", error);
        return [];
      }
    }

    // Update Map Markers based on selection
    function updateMapMarkers(selectedVehicle) {
      for (let reg in markers) {
        if (reg === selectedVehicle.registration) {
          markers[reg].setVisible(true);
          map.setCenter(markers[reg].getPosition());
          map.setZoom(18); // Street level zoom
        } else {
          markers[reg].setVisible(false);
        }
      }
    }

    // Display Selected Vehicle Details
    function displayVehicleDetails(vehicle) {
      const detailsList = document.getElementById('vehicleDetails');
      detailsList.innerHTML = `
        <li><strong>ID:</strong> ${vehicle.id}</li>
        <li><strong>Registration:</strong> ${vehicle.registration}</li>
        <li><strong>Model:</strong> ${vehicle.model}</li>
        <li><strong>Door Status:</strong> ${vehicle.doorStatus || 'Unavailable'}</li>
        <li><strong>Battery Level:</strong> ${vehicle.batteryLevel || 'Unavailable'}</li>
        <li><strong>System Status:</strong> ${vehicle.systemStatus || 'Unavailable'}</li>
        <li><strong>Last Active Time:</strong> ${vehicle.lastActiveTime || 'Unavailable'}</li>
        <li><strong>Last Known Location:</strong> ${vehicle.location 
          ? `Lat: ${vehicle.location.latitude}, Lng: ${vehicle.location.longitude}` 
          : 'Unavailable'}
        </li>
      `;

      document.getElementById('lockButton').disabled = false;
      document.getElementById('unlockButton').disabled = false;
    }

    // Event Listeners for Lock and Unlock Buttons
    document.getElementById('lockButton').addEventListener('click', async () => {
      if (selectedVehicle) {
        await commandCar(selectedVehicle.registration, 'LOCK');
        // Optionally refresh vehicle details
        const status = await getCarStatus(selectedVehicle.registration);
        if (status) {
          selectedVehicle.doorStatus = status.door_status;
          displayVehicleDetails(selectedVehicle);
        }
      }
    });

    document.getElementById('unlockButton').addEventListener('click', async () => {
      if (selectedVehicle) {
        await commandCar(selectedVehicle.registration, 'UNLOCK');
        // Optionally refresh vehicle details
        const status = await getCarStatus(selectedVehicle.registration);
        if (status) {
          selectedVehicle.doorStatus = status.door_status;
          displayVehicleDetails(selectedVehicle);
        }
      }
    });

    // Initialize map and fetch data on page load
    window.onload = () => {
      initMap();
      fetchVehicles();
    };
  </script>
</body>
</html>
