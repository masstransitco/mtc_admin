<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fleet Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* General Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Helvetica, Arial, sans-serif;
      background-color: #121212; /* Dark background */
      color: #fff;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: flex-start; /* Align toggle switch to the left */
      padding: 10px 20px;
      background-color: transparent; /* Changed to transparent */
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      height: 60px; /* Defined height for scroll adjustment */
    }

    /* Toggle Switch Styling */
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toggle-switch {
      position: relative;
      width: 60px;
      height: 34px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #2c2c2c;
      transition: 0.4s;
      border-radius: 34px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: 0.4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #276EF1;
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    /* Labels for Toggle Switch */
    .toggle-labels {
      display: flex;
      justify-content: space-between;
      width: 60px;
      font-size: 0.8rem;
      user-select: none;
    }

    /* Footer Styling */
    footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 20px;
      background-color: #1e1e1e;
      margin-top: auto; /* Push footer to the bottom */
    }

    footer img {
      height: 40px; /* Adjusted logo size */
    }

    .dropdown-container select {
      padding: 8px 12px;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      background-color: #2c2c2c;
      color: #fff;
      cursor: pointer;
    }

    .dropdown-container select:focus {
      outline: none;
      box-shadow: 0 0 5px #276EF1; /* Uber blue focus */
    }

    /* Lock and Unlock Buttons in Footer */
    .lock-buttons {
      display: flex;
      gap: 10px;
    }

    .lock-btn, .unlock-btn {
      padding: 10px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }

    .lock-btn {
      background-color: #C7C7CC; /* Uber gray */
      color: #000; /* Black text */
    }

    .unlock-btn {
      background-color: #09091A; /* Changed to #09091A */
      color: #fff; /* White text */
    }

    .unlock-btn:hover {
      opacity: 0.8;
    }

    .lock-btn:hover {
      opacity: 0.8;
    }

    .map-container {
      padding: 80px 20px 20px 20px; /* Top padding accounts for fixed header */
      flex: 1;
      transition: margin 0.3s ease;
    }

    #map {
      height: 60vh;
      width: 100%;
      border-radius: 10px;
    }

    .iframe-container, .alternative-container {
      width: calc(100% - 10px); /* Full width with 5px padding on both sides */
      max-width: 1280px;
      height: 216px; /* Reduced to 30% of 720px */
      margin: 20px auto;
      display: none; /* Hidden by default */
      border-radius: 10px;
      overflow: hidden;
      border: 2px solid #3A3A48; /* Added 2px border */
      padding: 10px; /* Increased left and right padding slightly */
      background-color: transparent; /* Transparent background */
    }

    .iframe-container.active, .alternative-container.active {
      display: block;
    }

    .iframe-container iframe, .alternative-container iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .details-section {
      padding: 20px;
      background-color: #1e1e1e;
      border-radius: 10px;
      margin: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .details-container {
      display: flex;
      gap: 20px;
    }

    .items-list {
      width: 50%;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .items-list ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .items-list li {
      padding: 15px;
      background: #2c2c2c;
      border-radius: 5px;
      border: 1px solid #444;
      font-size: 1rem;
    }

    .route-info {
      display: none; /* Hidden by default */
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .route-info .time {
      font-size: 2rem;
      font-weight: bold;
      color: #fff;
      text-shadow: 0 0 10px #276EF1; /* Illuminating effect */
      line-height: 1;
      display: block; /* Ensure it occupies its own line */
    }

    .route-info .unit {
      font-size: 1rem;
      color: #fff;
      text-shadow: 0 0 10px #276EF1; /* Illuminating effect */
      line-height: 1;
    }

    .route-details-toggle {
      color: #fff;
      text-decoration: underline;
      cursor: pointer;
      font-size: 0.9rem;
      align-self: flex-end;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .button-group button {
      padding: 10px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: opacity 0.3s ease;
    }

    .lock-btn {
      background-color: #C7C7CC; /* Uber gray */
      color: #000; /* Black text */
    }

    .unlock-btn {
      background-color: #09091A; /* Changed to #09091A */
      color: #fff; /* White text */
    }

    .choose-destination-btn, .pay-as-you-go-btn {
      background-color: #276EF1; /* Uber blue */
      color: #fff;
      padding: 10px 20px;
      font-size: 1rem;
      margin-bottom: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      transition: opacity 0.3s ease;
    }

    .pay-as-you-go-btn {
      background-color: #C7C7CC; /* Uber gray */
      color: #000;
    }

    .choose-destination-btn:hover, .pay-as-you-go-btn:hover, .lock-btn:hover, .unlock-btn:hover {
      opacity: 0.8;
    }

    .route-details {
      display: none; /* Hidden by default */
      margin-top: 10px;
      background: #2c2c2c;
      padding: 10px;
      border-radius: 5px;
      max-height: 200px;
      overflow-y: auto;
      font-size: 0.9rem;
    }

    /* Last Known Location Styles */
    .last-location {
      width: 100%;
      padding: 15px;
      background: #2c2c2c;
      border-radius: 5px;
      border: 1px solid #444;
      font-size: 1rem;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .last-location .address {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .last-location .address .english {
      font-size: 1rem;
    }

    .last-location .address .chinese {
      font-size: 1rem;
      font-weight: bold;
    }

    /* QR Code Scanner Fullscreen Overlay */
    .qr-scanner-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      display: none; /* Hidden by default */
    }

    .qr-scanner-container {
      position: relative;
      width: 80%;
      max-width: 400px;
      background-color: #1e1e1e;
      padding: 20px;
      border-radius: 10px;
    }

    .qr-scanner-container button.close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #C7C7CC;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      cursor: pointer;
      font-size: 1rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .details-container {
        flex-direction: column;
      }

      .items-list, .right-container {
        width: 100%;
      }

      .last-location {
        font-size: 0.9rem;
      }

      .map-container {
        padding: 80px 10px 10px 10px; /* Adjust padding for smaller screens */
      }

      .iframe-container, .alternative-container {
        height: 150px; /* Further reduce height on smaller screens */
      }
    }
  </style>
  <!-- Load Google Maps API with async, defer, and callback -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8rDrxBzMRlgbA7BQ2DoY31gEXzZ4Ours&libraries=places&language=zh-HK&callback=initMap"
    async
    defer
  ></script>
  <!-- Sketchfab Viewer API -->
  <script src="https://static.sketchfab.com/api/sketchfab-viewer-1.0.0.js"></script>
</head>
<body>
  <header>
    <div class="toggle-container">
      <label class="toggle-switch">
        <input type="checkbox" id="toggleSwitch">
        <span class="slider"></span>
      </label>
      <div class="toggle-labels">
        <span id="toggleLabel1">Cars</span>
        <span id="toggleLabel2">Stations</span>
      </div>
    </div>
  </header>

  <div class="map-container">
    <div id="map"></div>
  </div>

  <div class="iframe-container active" id="alternativeContainer">
    <iframe src="https://poly.cam/capture/7F309A54-AAEF-459D-8A2F-198E70A58D40/embed" title="GSViewer"></iframe>
  </div>

  <div class="iframe-container" id="sketchfabContainer">
    <iframe src="https://sketchfab.com/models/32182bd458674ea6969f8890ada5883f/embed?autostart=1&ui_controls=0&ui_watermark=0&ui_fullscreen=0&ui_navigation=0&ui_annotations=0&background=0" title="3D Model"></iframe>
  </div>

  <div class="details-section">
    <div class="details-container">
      <div class="items-list">
        <ul id="vehicleDetails">
          <!-- Dynamic Content -->
        </ul>
        <div class="route-info" id="routeInfo">
          <span class="time" id="walkingTime">0</span>
          <span class="unit">分钟</span>
        </div>
        <div class="route-details-toggle" id="routeToggle" style="display: none;">
          <span id="toggleText">Route details</span>
        </div>
        <div class="button-group">
          <button id="lockButton" class="lock-btn" disabled>Lock</button>
          <button id="unlockButton" class="unlock-btn" disabled>Unlock</button>
        </div>
      </div>
      <div class="right-container">
        <button id="chooseDestinationButton" class="choose-destination-btn" disabled>Choose Destination</button>
        <button id="payAsYouGoButton" class="pay-as-you-go-btn" disabled>Pay-As-You-Go</button>
      </div>
    </div>
    <div class="last-location" id="lastLocation">
      <!-- Dynamic Content -->
    </div>
    <div class="route-details" id="routeDetails">
      <!-- Turn-by-turn directions will be populated here -->
    </div>
  </div>

  <footer>
    <img src="logo.png" alt="Logo">
    <div class="dropdown-container">
      <select id="vehicleSelector">
        <option value="">-- Select a Vehicle --</option>
      </select>
    </div>
    <div class="lock-buttons">
      <button id="lockButtonFooter" class="lock-btn" disabled>Lock</button>
      <button id="unlockButtonFooter" class="unlock-btn" disabled>Unlock</button>
    </div>
  </footer>

  <!-- QR Code Scanner Overlay -->
  <div class="qr-scanner-overlay" id="qrScannerOverlay">
    <div class="qr-scanner-container">
      <button class="close-btn" id="closeQrScanner">&times;</button>
      <div id="qr-reader" style="width:100%"></div>
    </div>
  </div>

  <script>
    // Configuration
    const username = 'URBA00001'; // Replace with your username
    const token = 'fd58cd26fefc8c2b2ba1f7f52b33221a65f645790a43ff9b8da35db7da6e1f33';       // Replace with your token
    const auth = btoa(`${username}:${token}`);
    const baseUrl = 'https://fleetapi-hk.cartrack.com/rest';

    // Google Maps Datasets API Configuration
    const datasetsApiKey = 'YOUR_GOOGLE_MAPS_DATASETS_API_KEY'; // Replace with your Datasets API key
    const stationsSheetId = '1phOurVx6NwUxtMeeZZM296PuNzDs5HHLWAH6FaUZ2JU'; // Google Sheets ID
    const stationsRange = 'Sheet1!A:B'; // Adjust the range as per your sheet

    let map;
    let geocoder;
    let directionsService;
    let directionsRenderer;
    let userLocation = null;
    let carMarkers = {};
    let stationMarkers = {};
    let selectedVehicle = null;
    let vehicles = [];
    let stations = [];
    let currentMarkerType = 'Cars'; // Default state

    // Initialize Google Map with custom styles and services
    function initMap() {
      geocoder = new google.maps.Geocoder();
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        suppressMarkers: true,
        polylineOptions: {
          strokeColor: '#276EF1',
          strokeWeight: 4,
        }
      });

      // Custom Map Style (Maintained from previous setup)
      const customMapStyle = [
        {
          "featureType": "all",
          "elementType": "labels",
          "stylers": [
            { "visibility": "off" }
          ]
        },
        {
          "featureType": "administrative.locality",
          "elementType": "labels",
          "stylers": [
            { "visibility": "on" }
          ]
        },
        {
          "featureType": "administrative.locality",
          "elementType": "labels.text.fill",
          "stylers": [
            { "color": "#ffffff" }
          ]
        },
        {
          "featureType": "landscape",
          "elementType": "geometry",
          "stylers": [
            { "visibility": "on" },
            { "color": "#2c2c2c" }
          ]
        },
        {
          "featureType": "poi",
          "stylers": [
            { "visibility": "off" }
          ]
        },
        {
          "featureType": "road",
          "elementType": "labels",
          "stylers": [
            { "visibility": "off" }
          ]
        },
        {
          "featureType": "road",
          "elementType": "geometry",
          "stylers": [
            { "color": "#444444" }
          ]
        },
        {
          "featureType": "transit",
          "stylers": [
            { "visibility": "off" }
          ]
        },
        {
          "featureType": "water",
          "stylers": [
            { "color": "#000000" },
            { "visibility": "on" }
          ]
        }
      ];

      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 22.3193, lng: 114.1694 }, // Hong Kong
        zoom: 12,
        styles: customMapStyle,
        mapTypeId: 'terrain',
        streetViewControl: false,
        mapTypeControl: false,
      });

      directionsRenderer.setMap(map);
      directionsRenderer.setPanel(document.getElementById('routeDetails'));

      // Add user's current location as a blue dot
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLocation = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };

            const userLocationMarker = new google.maps.Marker({
              position: userLocation,
              map: map,
              title: 'Your Location',
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 8,
                fillColor: '#4285F4',
                fillOpacity: 1,
                strokeColor: 'white',
                strokeWeight: 2,
              },
            });
          },
          () => {
            handleLocationError(true, map.getCenter());
          }
        );
      } else {
        // Browser doesn't support Geolocation
        handleLocationError(false, map.getCenter());
      }

      // Fetch initial data
      fetchVehicles();
      fetchStations();

      // Add default locate and compass icons
      addMapControls();
    }

    function handleLocationError(browserHasGeolocation, pos) {
      console.error(
        browserHasGeolocation
          ? 'Error: The Geolocation service failed.'
          : "Error: Your browser doesn't support geolocation."
      );
    }

    // API Functions

    // Create request options
    function createRequestOptions(method, contentType = null, body = null) {
      let myHeaders = new Headers();
      myHeaders.append("Authorization", `Basic ${auth}`);
      if (contentType) {
        myHeaders.append("Content-Type", contentType);
      }
      let requestOptions = {
        method: method,
        headers: myHeaders,
        redirect: "follow",
      };
      if (body) {
        requestOptions.body = JSON.stringify(body);
      }
      return requestOptions;
    }

    // Get the list of vehicles
    async function getCars() {
      try {
        let url = `${baseUrl}/vehicles?limit=10000`;
        const requestOptions = createRequestOptions("GET", 'application/json');
        let response = await fetch(url, requestOptions);
        response = await response.json();
        console.log('API Response for Vehicles:', response); // Debugging Log
        return response;
      } catch (error) {
        console.error("Error fetching vehicles:", error);
        return null;
      }
    }

    // Get the status of a specific car
    async function getCarStatus(registration) {
      try {
        let url = `${baseUrl}/vehicles/status?filter[registration]=${encodeURIComponent(registration)}`;
        const requestOptions = createRequestOptions("GET");
        let response = await fetch(url, requestOptions);
        response = await response.json();
        console.log(`API Response for Vehicle Status (${registration}):`, response); // Debugging Log
        if (response?.data?.length) {
          return response.data[0];
        } else {
          console.warn(`No status data found for vehicle ${registration}.`);
          return null;
        }
      } catch (error) {
        console.error(`Error fetching status for vehicle ${registration}:`, error);
        return null;
      }
    }

    // Get statuses for multiple vehicles
    async function getCarsStatus(registrations) {
      try {
        let url = `${baseUrl}/vehicles/status?limit=10000`;
        const requestOptions = createRequestOptions("GET");
        let response = await fetch(url, requestOptions);
        response = await response.json();
        console.log('API Response for Multiple Vehicle Statuses:', response); // Debugging Log
        if (response?.data) {
          return response.data.filter(item => registrations.includes(item.registration));
        } else {
          return [];
        }
      } catch (error) {
        console.error("Error fetching vehicle statuses:", error);
        return [];
      }
    }

    // Command car (lock/unlock)
    async function commandCar(registration, commandType) {
      try {
        let url = `${baseUrl}/vehicles/${encodeURIComponent(registration)}/central-locking`;
        const requestOptions = createRequestOptions("PUT", 'application/json', { command: commandType });
        let response = await fetch(url, requestOptions);
        response = await response.json();
        alert(`Command '${commandType}' sent to vehicle ${registration}.`);
        console.log(`Command Response for ${registration}:`, response); // Debugging Log
        return response;
      } catch (error) {
        console.error(`Error sending command to vehicle ${registration}:`, error);
        alert(`Failed to send '${commandType}' command.`);
        return null;
      }
    }

    // Fetch vehicles and populate dropdown
    async function fetchVehicles() {
      const data = await getCars();
      console.log('Fetched Vehicles Data:', data); // Debugging Log
      if (data && Array.isArray(data.data)) {
        vehicles = data.data;
        populateDropdown(vehicles);
        await plotCarsOnMap(vehicles);
      } else {
        console.error("Invalid vehicle data received.");
      }
    }

    // Fetch Stations from Google Sheets via Datasets API
    async function fetchStations() {
      try {
        // Fetching stations from Google Sheets using Google Maps Datasets API
        // Note: You need to create a dataset in Google Maps Platform and link it to your Google Sheet
        const url = `https://maps.googleapis.com/maps/api/datasets/v1/datasets/YOUR_DATASET_ID/features?key=${datasetsApiKey}`;
        const response = await fetch(url);
        const data = await response.json();
        console.log('Fetched Stations Data:', data); // Debugging Log

        if (data.features && Array.isArray(data.features)) {
          stations = data.features.map(feature => ({
            id: feature.id,
            name: feature.properties.name,
            position: {
              lat: feature.geometry.coordinates[1],
              lng: feature.geometry.coordinates[0],
            }
          }));
          // Stations will be plotted when the toggle is set to "Stations"
        } else {
          console.error("Invalid stations data received.");
        }
      } catch (error) {
        console.error("Error fetching stations:", error);
      }
    }

    // Populate Dropdown
    function populateDropdown(vehicles) {
      const selector = document.getElementById('vehicleSelector');
      selector.innerHTML = `<option value="">-- Select a Vehicle --</option>`;
      vehicles.forEach(vehicle => {
        const option = document.createElement('option');
        option.value = vehicle.registration; // Using registration
        option.textContent = `${vehicle.registration} (${vehicle.model})`;
        selector.appendChild(option);
      });

      selector.addEventListener('change', async () => {
        const selectedRegistration = selector.value;
        if (selectedRegistration) {
          selectVehicle(selectedRegistration);
        } else {
          deselectVehicle();
        }
      });
    }

    // Plot Cars on Map
    async function plotCarsOnMap(vehicles) {
      // Clear existing markers
      for (let reg in carMarkers) {
        carMarkers[reg].setMap(null);
      }
      carMarkers = {};

      // Fetch status for all vehicles
      const statusResponse = await getCarsStatus(vehicles.map(v => v.registration));
      if (statusResponse && Array.isArray(statusResponse)) {
        vehicles.forEach(vehicle => {
          const status = statusResponse.find(s => s.registration === vehicle.registration);
          if (status && status.location) {
            vehicle.location = {
              lat: status.location.latitude,
              lng: status.location.longitude,
            };

            const marker = new google.maps.Marker({
              position: vehicle.location,
              map,
              title: vehicle.registration,
              icon: {
                url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
              }
            });

            marker.addListener('click', () => {
              selectVehicle(vehicle.registration);
              document.getElementById('vehicleSelector').value = vehicle.registration;
            });

            carMarkers[vehicle.registration] = marker;
          } else {
            console.warn(`No location data for vehicle ${vehicle.registration}.`);
          }
        });
      } else {
        console.error("Invalid status data received.");
      }
    }

    // Plot Stations on Map
    function plotStationsOnMap(stations) {
      // Clear existing station markers
      for (let id in stationMarkers) {
        stationMarkers[id].setMap(null);
      }
      stationMarkers = {};

      stations.forEach(station => {
        const marker = new google.maps.Marker({
          position: station.position,
          map,
          title: station.name,
          icon: {
            url: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
          }
        });

        marker.addListener('click', () => {
          // Handle station marker click if needed
          alert(`Station: ${station.name}`);
        });

        stationMarkers[station.id] = marker;
      });
    }

    // Select Vehicle (from dropdown or marker)
    async function selectVehicle(registration) {
      selectedVehicle = vehicles.find(v => v.registration === registration);
      if (selectedVehicle) {
        const status = await getCarStatus(selectedVehicle.registration);
        if (status) {
          selectedVehicle.location = {
            lat: status.location.latitude,
            lng: status.location.longitude,
          };
          selectedVehicle.doorStatus = status.door_status;
          selectedVehicle.batteryLevel = status.battery_level;
          selectedVehicle.systemStatus = status.system_status;
          selectedVehicle.lastActiveTime = status.last_active_time;
        }
        displayVehicleDetails(selectedVehicle);
        showSketchfab();
        plotRoute();
        illuminateMarker(selectedVehicle.registration);
        applySketchfabTextures(selectedVehicle.registration);
        document.getElementById('routeToggle').style.display = 'block';
      }
    }

    // Deselect Vehicle
    function deselectVehicle() {
      selectedVehicle = null;
      clearDetails();
      hideSketchfab();
      clearRoute();
      document.getElementById('lockButtonFooter').disabled = true;
      document.getElementById('unlockButtonFooter').disabled = true;
      document.getElementById('chooseDestinationButton').disabled = true;
      document.getElementById('payAsYouGoButton').disabled = true;
      // Hide Route Info and Details
      document.getElementById('routeInfo').classList.remove('active');
      document.getElementById('routeInfo').style.display = 'none';
      document.getElementById('routeToggle').style.display = 'none';
      document.getElementById('routeDetails').style.display = 'none';
      // Show alternative iframe
      document.getElementById('alternativeContainer').classList.add('active');
      // Remove illumination from all markers
      removeMarkerIllumination();
    }

    // Illuminate Selected Marker
    function illuminateMarker(registration) {
      removeMarkerIllumination(); // Remove previous illumination
      const marker = carMarkers[registration];
      if (marker) {
        marker.setIcon({
          url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
        });
      }
    }

    // Remove illumination from all markers
    function removeMarkerIllumination() {
      for (let reg in carMarkers) {
        carMarkers[reg].setIcon({
          url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
        });
      }
    }

    // Display Vehicle Details
    function displayVehicleDetails(vehicle) {
      const detailsList = document.getElementById('vehicleDetails');
      detailsList.innerHTML = `
        <li><strong>Station:</strong></li>
        <li class="address">
          <span class="english">Fetching address...</span>
          <span class="chinese">獲取地址中...</span>
        </li>
        <li><strong>Registration:</strong> ${vehicle.registration}</li>
        <li><strong>Model:</strong> ${vehicle.model}</li>
        <li><strong>Status:</strong> Parked and Available ✅</li>
      `;

      // Convert lat/lng to address
      if (vehicle.location) {
        geocoder.geocode({ location: vehicle.location }, (results, status) => {
          if (status === 'OK') {
            if (results[0]) {
              const address = results[0].formatted_address;
              const chineseAddress = results[0].address_components.find(comp => comp.types.includes('administrative_area_level_1'))?.long_name || 'N/A';
              const addressElements = detailsList.querySelectorAll('.address span');
              addressElements[0].textContent = address;
              addressElements[1].textContent = chineseAddress;
            } else {
              const addressElements = detailsList.querySelectorAll('.address span');
              addressElements[0].textContent = 'No address found';
              addressElements[1].textContent = '無地址找到';
            }
          } else {
            console.error('Geocoder failed due to: ' + status);
            const addressElements = detailsList.querySelectorAll('.address span');
            addressElements[0].textContent = `${vehicle.location.lat}, ${vehicle.location.lng}`;
            addressElements[1].textContent = '無地址找到';
          }
        });
      } else {
        const addressElements = detailsList.querySelectorAll('.address span');
        addressElements[0].textContent = 'Unavailable';
        addressElements[1].textContent = '不可用';
      }

      // Enable buttons in footer
      document.getElementById('lockButtonFooter').disabled = false;
      document.getElementById('unlockButtonFooter').disabled = false;
      document.getElementById('chooseDestinationButton').disabled = false;
      document.getElementById('payAsYouGoButton').disabled = false;
    }

    // Clear Vehicle Details
    function clearDetails() {
      const detailsList = document.getElementById('vehicleDetails');
      detailsList.innerHTML = ``; // Removed default text
      document.getElementById('lastLocation').innerHTML = '';
    }

    // Show Sketchfab iframe and hide alternative
    function showSketchfab() {
      document.getElementById('sketchfabContainer').classList.add('active');
      document.getElementById('alternativeContainer').classList.remove('active');
    }

    // Hide Sketchfab iframe and show alternative
    function hideSketchfab() {
      document.getElementById('sketchfabContainer').classList.remove('active');
      document.getElementById('alternativeContainer').classList.add('active');
    }

    // Plot Route from user to selected vehicle or station
    async function plotRoute() {
      if (userLocation && selectedVehicle && selectedVehicle.location) {
        const request = {
          origin: userLocation,
          destination: selectedVehicle.location,
          travelMode: 'WALKING',
        };

        directionsService.route(request, (result, status) => {
          if (status === 'OK') {
            directionsRenderer.setDirections(result);
            // Calculate walking time
            const legs = result.routes[0].legs;
            if (legs.length > 0) {
              const duration = legs[0].duration.text; // e.g., "5 mins"
              const durationInMinutes = legs[0].duration.value / 60; // Convert to minutes
              const durationText = `${Math.round(durationInMinutes)} 分钟`;
              document.getElementById('walkingTime').textContent = Math.round(durationInMinutes);
              document.getElementById('routeInfo').classList.add('active');
              document.getElementById('routeInfo').style.display = 'flex';
              document.getElementById('routeToggle').style.display = 'block';

              // Add annotation on the map
              const infoWindow = new google.maps.InfoWindow({
                content: `<div style="color: black;">${durationText}</div>`,
                position: selectedVehicle.location,
              });
              infoWindow.open(map);
              // Close after a certain time if needed
              setTimeout(() => {
                infoWindow.close();
              }, 5000); // Closes after 5 seconds
            }

            // Populate route details
            populateRouteDetails(result.routes[0]);

            // Adjust map to fit the route
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(userLocation);
            bounds.extend(selectedVehicle.location);
            map.fitBounds(bounds);
          } else {
            console.error('Directions request failed due to ' + status);
          }
        });
      } else {
        console.warn('User location or selected vehicle location is unavailable.');
      }
    }

    // Clear Route
    function clearRoute() {
      directionsRenderer.set('directions', null);
      document.getElementById('walkingTime').textContent = '0';
      document.getElementById('walkingTime').nextElementSibling.textContent = '分钟';
      document.getElementById('routeInfo').classList.remove('active');
      document.getElementById('routeInfo').style.display = 'none';
      document.getElementById('routeToggle').style.display = 'none';
      document.getElementById('routeDetails').style.display = 'none';
    }

    // Toggle Switch Functionality
    const toggleSwitch = document.getElementById('toggleSwitch');
    toggleSwitch.addEventListener('change', () => {
      if (toggleSwitch.checked) {
        currentMarkerType = 'Stations';
        document.getElementById('toggleLabel1').textContent = 'Stations';
        document.getElementById('toggleLabel2').textContent = 'Cars';
        showStations();
      } else {
        currentMarkerType = 'Cars';
        document.getElementById('toggleLabel1').textContent = 'Cars';
        document.getElementById('toggleLabel2').textContent = 'Stations';
        showCars();
      }
      // Clear any existing pedestrian routes
      clearRoute();
    });

    function showCars() {
      // Hide station markers
      for (let id in stationMarkers) {
        stationMarkers[id].setMap(null);
      }
      // Show car markers
      for (let reg in carMarkers) {
        carMarkers[reg].setMap(map);
      }
    }

    function showStations() {
      // Hide car markers
      for (let reg in carMarkers) {
        carMarkers[reg].setMap(null);
      }
      // Show station markers
      for (let id in stationMarkers) {
        stationMarkers[id].setMap(map);
      }
    }

    // Vehicle Commands in Footer
    document.getElementById('lockButtonFooter').addEventListener('click', async () => {
      if (selectedVehicle) {
        await commandCar(selectedVehicle.registration, 'LOCK');
        // Optionally refresh vehicle details
        const status = await getCarStatus(selectedVehicle.registration);
        if (status) {
          selectedVehicle.doorStatus = status.door_status;
          displayVehicleDetails(selectedVehicle);
        }
      }
    });

    document.getElementById('unlockButtonFooter').addEventListener('click', async () => {
      if (selectedVehicle) {
        const confirmUnlock = confirm(`You’re about to unlock the doors for the vehicle with plate number: ${selectedVehicle.registration}. Do you want to proceed?`);
        if (confirmUnlock) {
          await commandCar(selectedVehicle.registration, 'UNLOCK');
          // Optionally refresh vehicle details
          const status = await getCarStatus(selectedVehicle.registration);
          if (status) {
            selectedVehicle.doorStatus = status.door_status;
            displayVehicleDetails(selectedVehicle);
          }
        }
      }
    });

    // Choose Destination Button (Placeholder)
    document.getElementById('chooseDestinationButton').addEventListener('click', () => {
      openQrScanner();
    });

    // Pay-As-You-Go Button (Placeholder)
    document.getElementById('payAsYouGoButton').addEventListener('click', () => {
      openQrScanner();
    });

    // QR Code Scanner Functions
    function openQrScanner() {
      document.getElementById('qrScannerOverlay').style.display = 'flex';
      initializeQrScanner();
    }

    function closeQrScanner() {
      document.getElementById('qrScannerOverlay').style.display = 'none';
      // Stop the QR scanner if necessary
      if (window.qrScannerInstance) {
        window.qrScannerInstance.stop();
      }
    }

    document.getElementById('closeQrScanner').addEventListener('click', closeQrScanner);

    // Initialize QR Scanner (Using html5-qrcode library)
    function initializeQrScanner() {
      if (window.qrScannerInstance) {
        window.qrScannerInstance.clear();
      }
      const html5QrCode = new Html5Qrcode("qr-reader");
      window.qrScannerInstance = html5QrCode;

      const qrCodeSuccessCallback = (decodedText, decodedResult) => {
        // Handle the scanned QR code data
        alert(`QR Code Scanned: ${decodedText}`);
        closeQrScanner();
      };

      const config = { fps: 10, qrbox: 250 };

      // Start scanning
      html5QrCode.start(
        { facingMode: "environment" },
        config,
        qrCodeSuccessCallback
      ).catch(err => {
        console.error(`Unable to start scanning, error: ${err}`);
      });
    }

    // Initialize map and fetch data on page load
    window.onload = () => {
      // initMap is now called via the callback parameter in the script tag
      // fetchVehicles(); // Already called in initMap
      // fetchStations(); // Already called in initMap
    };

    // Sketchfab Viewer API Integration
    let sketchfabAPI;
    let sketchfabViewer;

    function initializeSketchfab() {
      const iframe = document.getElementById('sketchfabContainer').querySelector('iframe');
      sketchfabAPI = new Sketchfab('1.0.0', iframe);
      sketchfabAPI.init('32182bd458674ea6969f8890ada5883f', {
        success: function(api) {
          sketchfabViewer = api;
          sketchfabViewer.start();
          sketchfabViewer.addEventListener('viewerready', function() {
            console.log('Sketchfab model loaded.');
            // Set initial view to Annotation 1
            sketchfabViewer.getCameraLookAt(function(result, data) {
              if (result) {
                // Adjust camera to Annotation 1 coordinates if available
                // This requires knowing the coordinates or annotations setup in the model
              }
            });
          });
        },
        error: function() {
          console.error('Sketchfab API error.');
        }
      });
    }

    // Apply Textures to Sketchfab Model Based on Vehicle Selection
    function applySketchfabTextures(registration) {
      if (!sketchfabViewer) {
        console.error('Sketchfab Viewer API not initialized.');
        return;
      }

      const textureMappings = {
        "YV2570": {
          "Plain_r1_g1_a1_texture_path": "re_16_Artboard_8.png",
          "Plain_r0.576471_g0.301961_b0.00392158_a1_texture_path": "rerere_13_3617b_Copy.png"
        },
        "YV3617": {
          "Plain_r1_g1_a1_texture_path": "re_17_Artboard_8_Copy.png",
          "Plain_r0.576471_g0.301961_b0.00392158_a1_texture_path": "rerere_14_2570b_Copy.png"
        },
        "ZK2548": {
          "Plain_r1_g1_a1_texture_path": "re_18_Artboard_8_Copy_2.png",
          "Plain_r0.576471_g0.301961_b0.00392158_a1_texture_path": "rerere_15_2548b_Copy.png"
        },
        "YV4136": {
          "Plain_r1_g1_a1_texture_path": "re_19_Artboard_8_Copy_3.png",
          "Plain_r0.576471_g0.301961_b0.00392158_a1_texture_path": "rerere_11_4136b_Copy.png"
        },
        "ZK5419": {
          "Plain_r0.576471_g0.301961_b0.00392158_a1_texture_path": "rerere_12_5419b_Copy.png"
        }
      };

      const vehicleTextures = textureMappings[registration];
      if (!vehicleTextures) {
        console.warn(`No texture mappings found for vehicle ${registration}.`);
        return;
      }

      // Apply each texture to the corresponding material
      for (let material in vehicleTextures) {
        const texturePath = vehicleTextures[material];
        sketchfabViewer.setMaterialTexture(material, texturePath, {
          scale: [1, 1],
          rotation: 0,
          offset: [0, 0],
          opacity: 1
        }, function(success, message) {
          if (success) {
            console.log(`Applied texture ${texturePath} to ${material}.`);
          } else {
            console.error(`Failed to apply texture ${texturePath} to ${material}: ${message}`);
          }
        });
      }
    }

    // Initialize Sketchfab after the iframe has loaded
    window.addEventListener('load', () => {
      initializeSketchfab();
    });

    // Add Default Locate and Compass Icons to Map Corners
    function addMapControls() {
      // Locate Control
      const locateControlDiv = document.createElement('div');
      const locateControl = document.createElement('button');
      locateControl.style.backgroundColor = '#fff';
      locateControl.style.border = 'none';
      locateControl.style.outline = 'none';
      locateControl.style.width = '40px';
      locateControl.style.height = '40px';
      locateControl.style.borderRadius = '3px';
      locateControl.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
      locateControl.style.cursor = 'pointer';
      locateControl.style.margin = '10px';
      locateControl.style.padding = '0';
      locateControl.title = 'Center on Me';

      // Add Locate Icon (Compass)
      locateControl.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000">
          <path d="M0 0h24v24H0V0z" fill="none"/>
          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.93 0-3.5-1.57-3.5-3.5S10.07 4.5 12 4.5 15.5 6.07 15.5 8 13.93 11.5 12 11.5z"/>
        </svg>
      `;

      locateControlDiv.appendChild(locateControl);
      map.controls[google.maps.ControlPosition.TOP_LEFT].push(locateControlDiv);

      locateControl.addEventListener('click', () => {
        if (userLocation) {
          map.setCenter(userLocation);
          map.setZoom(14);
        } else {
          alert('User location is unavailable.');
        }
      });

      // Compass Control (Example: Reset Orientation)
      const compassControlDiv = document.createElement('div');
      const compassControl = document.createElement('button');
      compassControl.style.backgroundColor = '#fff';
      compassControl.style.border = 'none';
      compassControl.style.outline = 'none';
      compassControl.style.width = '40px';
      compassControl.style.height = '40px';
      compassControl.style.borderRadius = '3px';
      compassControl.style.boxShadow = '0 2px 6px rgba(0,0,0,0.3)';
      compassControl.style.cursor = 'pointer';
      compassControl.style.margin = '10px';
      compassControl.style.padding = '0';
      compassControl.title = 'Reset Orientation';

      // Add Compass Icon
      compassControl.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000">
          <path d="M0 0h24v24H0V0z" fill="none"/>
          <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.93 0-3.5-1.57-3.5-3.5S10.07 4.5 12 4.5 15.5 6.07 15.5 8 13.93 11.5 12 11.5z"/>
          <path d="M0 0h24v24H0V0z" fill="none"/>
        </svg>
      `;

      compassControlDiv.appendChild(compassControl);
      map.controls[google.maps.ControlPosition.TOP_LEFT].push(compassControlDiv);

      compassControl.addEventListener('click', () => {
        map.setTilt(45); // Example action: Change tilt
      });
    }

    // Vehicle Commands in Footer
    document.getElementById('lockButtonFooter').addEventListener('click', async () => {
      if (selectedVehicle) {
        await commandCar(selectedVehicle.registration, 'LOCK');
        // Optionally refresh vehicle details
        const status = await getCarStatus(selectedVehicle.registration);
        if (status) {
          selectedVehicle.doorStatus = status.door_status;
          displayVehicleDetails(selectedVehicle);
        }
      }
    });

    document.getElementById('unlockButtonFooter').addEventListener('click', async () => {
      if (selectedVehicle) {
        const confirmUnlock = confirm(`You’re about to unlock the doors for the vehicle with plate number: ${selectedVehicle.registration}. Do you want to proceed?`);
        if (confirmUnlock) {
          await commandCar(selectedVehicle.registration, 'UNLOCK');
          // Optionally refresh vehicle details
          const status = await getCarStatus(selectedVehicle.registration);
          if (status) {
            selectedVehicle.doorStatus = status.door_status;
            displayVehicleDetails(selectedVehicle);
          }
        }
      }
    });

    // Choose Destination Button (Placeholder)
    document.getElementById('chooseDestinationButton').addEventListener('click', () => {
      openQrScanner();
    });

    // Pay-As-You-Go Button (Placeholder)
    document.getElementById('payAsYouGoButton').addEventListener('click', () => {
      openQrScanner();
    });

    // QR Code Scanner Functions (Using html5-qrcode library)
    function openQrScanner() {
      document.getElementById('qrScannerOverlay').style.display = 'flex';
      initializeQrScanner();
    }

    function closeQrScanner() {
      document.getElementById('qrScannerOverlay').style.display = 'none';
      // Stop the QR scanner if necessary
      if (window.qrScannerInstance) {
        window.qrScannerInstance.stop().then(ignore => {
          window.qrScannerInstance.clear();
          window.qrScannerInstance = null;
        }).catch(err => {
          console.error('Failed to stop QR scanner:', err);
        });
      }
    }

    document.getElementById('closeQrScanner').addEventListener('click', closeQrScanner);

    // Initialize QR Scanner (Using html5-qrcode library)
    function initializeQrScanner() {
      if (window.qrScannerInstance) {
        window.qrScannerInstance.clear();
      }
      const html5QrCode = new Html5Qrcode("qr-reader");
      window.qrScannerInstance = html5QrCode;

      const qrCodeSuccessCallback = (decodedText, decodedResult) => {
        // Handle the scanned QR code data
        alert(`QR Code Scanned: ${decodedText}`);
        closeQrScanner();
      };

      const config = { fps: 10, qrbox: 250 };

      // Start scanning
      html5QrCode.start(
        { facingMode: "environment" },
        config,
        qrCodeSuccessCallback
      ).catch(err => {
        console.error(`Unable to start scanning, error: ${err}`);
      });
    }

    // Initialize map and fetch data on page load
    window.onload = () => {
      // initMap is now called via the callback parameter in the script tag
      // fetchVehicles(); // Already called in initMap
      // fetchStations(); // Already called in initMap
    };

    // Sketchfab Viewer API Integration
    let sketchfabAPI;
    let sketchfabViewer;

    function initializeSketchfab() {
      const iframe = document.getElementById('sketchfabContainer').querySelector('iframe');
      sketchfabAPI = new Sketchfab('1.0.0', iframe);
      sketchfabAPI.init('32182bd458674ea6969f8890ada5883f', {
        success: function(api) {
          sketchfabViewer = api;
          sketchfabViewer.start();
          sketchfabViewer.addEventListener('viewerready', function() {
            console.log('Sketchfab model loaded.');
            // Set initial view to Annotation 1
            // Assuming Annotation 1 corresponds to a specific camera position
            // You may need to adjust this based on your model's annotations
            // Placeholder: Move camera to a predefined position
            sketchfabViewer.getCameraLookAt(function(result, data) {
              if (result) {
                // Example: Set camera to specific coordinates (replace with actual)
                sketchfabViewer.setCameraLookAt([0, 0, 0], [0, 0, 0], [0, 0, 0], function(success, message) {
                  if (success) {
                    console.log('Camera set to Annotation 1.');
                  } else {
                    console.error(`Failed to set camera: ${message}`);
                  }
                });
              }
            });

            // Remove default buttons and tools via CSS or Sketchfab API
            // Note: Some elements may not be removable via API and require account settings
          });
        },
        error: function() {
          console.error('Sketchfab API error.');
        }
      });
    }

    // Apply Textures to Sketchfab Model Based on Vehicle Selection
    function applySketchfabTextures(registration) {
      if (!sketchfabViewer) {
        console.error('Sketchfab Viewer API not initialized.');
        return;
      }

      const textureMappings = {
        "YV2570": {
          "Plain_r1_g1_a1_texture_path": "re_16_Artboard_8.png",
          "Plain_r0.576471_g0.301961_b0.00392158_a1_texture_path": "rerere_13_3617b_Copy.png"
        },
        "YV3617": {
          "Plain_r1_g1_a1_texture_path": "re_17_Artboard_8_Copy.png",
          "Plain_r0.576471_g0.301961_b0.00392158_a1_texture_path": "rerere_14_2570b_Copy.png"
        },
        "ZK2548": {
          "Plain_r1_g1_a1_texture_path": "re_18_Artboard_8_Copy_2.png",
          "Plain_r0.576471_g0.301961_b0.00392158_a1_texture_path": "rerere_15_2548b_Copy.png"
        },
        "YV4136": {
          "Plain_r1_g1_a1_texture_path": "re_19_Artboard_8_Copy_3.png",
          "Plain_r0.576471_g0.301961_b0.00392158_a1_texture_path": "rerere_11_4136b_Copy.png"
        },
        "ZK5419": {
          "Plain_r0.576471_g0.301961_b0.00392158_a1_texture_path": "rerere_12_5419b_Copy.png"
        }
      };

      const vehicleTextures = textureMappings[registration];
      if (!vehicleTextures) {
        console.warn(`No texture mappings found for vehicle ${registration}.`);
        return;
      }

      // Apply each texture to the corresponding material
      for (let material in vehicleTextures) {
        const texturePath = vehicleTextures[material];
        sketchfabViewer.setMaterialTexture(material, texturePath, {
          scale: [1, 1],
          rotation: 0,
          offset: [0, 0],
          opacity: 1
        }, function(success, message) {
          if (success) {
            console.log(`Applied texture ${texturePath} to ${material}.`);
          } else {
            console.error(`Failed to apply texture ${texturePath} to ${material}: ${message}`);
          }
        });
      }
    }

    // Initialize Sketchfab after the iframe has loaded
    window.addEventListener('load', () => {
      initializeSketchfab();
    });
  </script>
  <!-- Include html5-qrcode library for QR code scanning -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</body>
</html>
