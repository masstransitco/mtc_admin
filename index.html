<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fleet Ops</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* General Reset */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Helvetica, Arial, sans-serif;
      background-color: #121212; /* Dark background to complement dark map */
      color: #fff;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between; /* Align items to left and right */
      padding: 2px 20px; /* 2px padding on top and bottom */
      background-color: #1e1e1e; /* Slightly lighter dark for header */
      height: 60px; /* Adjust height to accommodate dropdown */
    }

    header img {
      height: 40px;
      margin-right: 10px;
    }

    .dropdown-container {
      /* Additional styling if needed */
    }

    .dropdown-container select {
      padding: 5px;
      font-size: 1rem;
    }

    .map-container {
      padding: 0 20px;
    }

    #map {
      height: 50vh;
      width: 100%;
    }

    .details-section {
      padding: 20px;
      background-color: #1e1e1e;
      overflow-y: auto;
    }

    .details-section h2 {
      margin-bottom: 10px;
    }

    .details-container {
      display: flex;
    }

    .items-list {
      width: 50%;
    }

    .items-list ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }

    .items-list li {
      padding: 10px;
      background: #2c2c2c;
      margin-bottom: 5px;
      border-radius: 5px;
      border: 1px solid #444;
    }

    .items-list .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .items-list button {
      padding: 10px 15px;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .lock-btn {
      background-color: #C7C7CC; /* Uber gray */
      color: #000; /* Black text */
    }

    .unlock-btn {
      background-color: #276EF1; /* Uber blue */
      color: #fff; /* White text */
    }

    button:hover {
      opacity: 0.9;
    }

    .right-container {
      width: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: sans-serif;
    }

    .choose-destination-btn {
      background-color: #276EF1; /* Uber blue */
      color: #fff;
      padding: 10px 20px;
      font-size: 1rem;
      margin-bottom: 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .pay-as-you-go-btn {
      background-color: #C7C7CC; /* Uber gray */
      color: #000;
      padding: 10px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    /* Container for 3D Model */
    .model-container {
      width: 100%;
      height: 0;
      padding-bottom: 30%; /* Aspect ratio of 0.3 */
      position: relative;
      margin-bottom: 20px;
    }

    .model-container iframe {
      position: absolute;
      width: 100%;
      height: 100%;
      border: none;
    }
  </style>
  <!-- Replace 'YOUR_GOOGLE_MAPS_API_KEY' with your actual Google Maps API key -->
  <script async src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA8rDrxBzMRlgbA7BQ2DoY31gEXzZ4Ours&language=zh-HK"></script>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo">
    <div class="dropdown-container">
      <select id="vehicleSelector">
        <option value="">-- Loading Vehicles --</option>
      </select>
    </div>
  </header>

  <div class="map-container">
    <div id="map"></div>
  </div>

  <div class="details-section">
    <h2>Details</h2>
    <div class="details-container">
      <div class="items-list">
        <!-- Embed Sketchfab 3D Model -->
        <div class="model-container">
          <div class="sketchfab-embed-wrapper">
            <iframe title="mtc" frameborder="0" allowfullscreen mozallowfullscreen="true"
              webkitallowfullscreen="true" allow="autoplay; fullscreen; xr-spatial-tracking"
              xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share
              width="640" height="480"
              src="https://sketchfab.com/models/2c530666fa834f71b75f526f1bb1eb40/embed?autostart=1&camera=0&ui_animations=0&ui_infos=0&ui_stop=0&ui_inspector=0&ui_watermark_link=0&ui_watermark=0&ui_ar=0&ui_help=0&ui_settings=0&ui_vr=0&ui_fullscreen=0&ui_annotations=0">
            </iframe>
          </div>
        </div>
        <ul id="vehicleDetails">
          <li>Select a vehicle to see details here...</li>
        </ul>
        <div class="button-group">
          <button id="lockButton" class="lock-btn" disabled>Lock</button>
          <button id="unlockButton" class="unlock-btn" disabled>Unlock</button>
        </div>
      </div>
      <div class="right-container">
        <button id="chooseDestinationButton" class="choose-destination-btn">Choose Destination</button>
        <button id="payAsYouGoButton" class="pay-as-you-go-btn">Pay-As-You-Go</button>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const username = 'URBA00001'; // Replace with your username
    const token = 'fd58cd26fefc8c2b2ba1f7f52b33221a65f645790a43ff9b8da35db7da6e1f33';       // Replace with your token
    const auth = btoa(`${username}:${token}`);
    const baseUrl = 'https://fleetapi-hk.cartrack.com/rest';

    let map;
    let geocoder;
    let markers = {};
    let selectedVehicle = null;
    let vehicles = [];

    // Initialize Google Map with terrain and custom styles
    function initMap() {
      geocoder = new google.maps.Geocoder();

      const customMapStyle = [
        {
          "featureType": "all",
          "elementType": "labels",
          "stylers": [
            { "visibility": "off" }
          ]
        },
        {
          "featureType": "administrative.locality",
          "elementType": "labels",
          "stylers": [
            { "visibility": "on" }
          ]
        },
        {
          "featureType": "administrative.locality",
          "elementType": "labels.text.fill",
          "stylers": [
            { "color": "#ffffff" }
          ]
        },
        // Show terrain
        {
          "featureType": "landscape",
          "elementType": "geometry",
          "stylers": [
            { "visibility": "on" },
            { "color": "#2c2c2c" }
          ]
        },
        // Hide points of interest and road labels
        {
          "featureType": "poi",
          "stylers": [
            { "visibility": "off" }
          ]
        },
        {
          "featureType": "road",
          "elementType": "labels",
          "stylers": [
            { "visibility": "off" }
          ]
        },
        // Additional styling as needed
      ];

      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 22.3193, lng: 114.1694 }, // Default center (Hong Kong)
        zoom: 12,
        styles: customMapStyle,
        streetViewControl: false,
        mapTypeControl: false,
        mapTypeId: 'terrain',
      });

      // Add user's current location as a blue dot
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            const pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude,
            };

            const userLocationMarker = new google.maps.Marker({
              position: pos,
              map: map,
              title: 'Your Location',
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 8,
                fillColor: '#4285F4',
                fillOpacity: 1,
                strokeColor: 'white',
                strokeWeight: 2,
              },
            });

            // Optional: Center map on user's location
            // map.setCenter(pos);
          },
          () => {
            handleLocationError(true, map.getCenter());
          }
        );
      } else {
        // Browser doesn't support Geolocation
        handleLocationError(false, map.getCenter());
      }

      function handleLocationError(browserHasGeolocation, pos) {
        console.error(
          browserHasGeolocation
            ? 'Error: The Geolocation service failed.'
            : "Error: Your browser doesn't support geolocation."
        );
      }
    }

    // API Functions

    // Create request options
    function createRequestOptions(method, contentType = null, body = null) {
      let myHeaders = new Headers();
      myHeaders.append("Authorization", `Basic ${auth}`);
      if (contentType) {
        myHeaders.append("Content-Type", contentType);
      }
      let requestOptions = {
        method: method,
        headers: myHeaders,
        redirect: "follow",
      };
      if (body) {
        requestOptions.body = JSON.stringify(body);
      }
      return requestOptions;
    }

    // Get the list of vehicles
    async function getCars() {
      try {
        let url = `${baseUrl}/vehicles?limit=10000`;
        const requestOptions = createRequestOptions("GET", 'application/json');
        let response = await fetch(url, requestOptions);
        response = await response.json();
        return response;
      } catch (error) {
        console.error("Error fetching vehicles:", error);
        return null;
      }
    }

    // Get the status of a specific car
    async function getCarStatus(registration) {
      try {
        let url = `${baseUrl}/vehicles/status?filter[registration]=${encodeURIComponent(registration)}`;
        const requestOptions = createRequestOptions("GET");
        let response = await fetch(url, requestOptions);
        response = await response.json();
        if (response?.data?.length) {
          return response.data[0];
        } else {
          console.warn(`No status data found for vehicle ${registration}.`);
          return null;
        }
      } catch (error) {
        console.error(`Error fetching status for vehicle ${registration}:`, error);
        return null;
      }
    }

    // Get statuses for multiple vehicles
    async function getCarsStatus(registrations) {
      try {
        let url = `${baseUrl}/vehicles/status?limit=10000`;
        const requestOptions = createRequestOptions("GET");
        let response = await fetch(url, requestOptions);
        response = await response.json();
        if (response?.data) {
          return response.data.filter(item => registrations.includes(item.registration));
        } else {
          return [];
        }
      } catch (error) {
        console.error("Error fetching vehicle statuses:", error);
        return [];
      }
    }

    // Command car (lock/unlock)
    async function commandCar(registration, commandType) {
      try {
        let url = `${baseUrl}/vehicles/${encodeURIComponent(registration)}/central-locking`;
        const requestOptions = createRequestOptions("PUT", 'application/json', { command: commandType });
        let response = await fetch(url, requestOptions);
        response = await response.json();
        alert(`Command '${commandType}' sent to vehicle ${registration}.`);
        return response;
      } catch (error) {
        console.error(`Error sending command to vehicle ${registration}:`, error);
        alert(`Failed to send '${commandType}' command.`);
        return null;
      }
    }

    // Fetch vehicles and populate dropdown
    async function fetchVehicles() {
      const data = await getCars();
      if (data && Array.isArray(data.data)) {
        vehicles = data.data;
        populateDropdown(vehicles);
        await plotVehiclesOnMap(vehicles);
      } else {
        console.error("Invalid vehicle data received.");
      }
    }

    // Populate Dropdown
    function populateDropdown(vehicles) {
      const selector = document.getElementById('vehicleSelector');
      selector.innerHTML = `<option value="">-- Select a Vehicle --</option>`;
      vehicles.forEach(vehicle => {
        const option = document.createElement('option');
        option.value = vehicle.registration; // Using registration
        option.textContent = `${vehicle.registration} (${vehicle.model})`;
        selector.appendChild(option);
      });

      selector.addEventListener('change', async () => {
        const selectedRegistration = selector.value;
        if (selectedRegistration) {
          selectedVehicle = vehicles.find(v => v.registration === selectedRegistration);
          const status = await getCarStatus(selectedVehicle.registration);
          if (status) {
            selectedVehicle.location = {
              lat: status.location.latitude,
              lng: status.location.longitude,
            };
            selectedVehicle.doorStatus = status.door_status;
            selectedVehicle.batteryLevel = status.battery_level;
            selectedVehicle.systemStatus = status.system_status;
            selectedVehicle.lastActiveTime = status.last_active_time;
          }
          displayVehicleDetails(selectedVehicle);
          updateMapMarkers(selectedVehicle);
        } else {
          selectedVehicle = null;
          document.getElementById('lockButton').disabled = true;
          document.getElementById('unlockButton').disabled = true;
          // Show all markers
          for (let reg in markers) {
            markers[reg].setVisible(true);
          }
          map.setZoom(12);
          map.setCenter({ lat: 22.3193, lng: 114.1694 });
        }
      });
    }

    // Plot Vehicles on Map
    async function plotVehiclesOnMap(vehicles) {
      // Clear existing markers
      for (let reg in markers) {
        markers[reg].setMap(null);
      }
      markers = {};

      // Fetch status for all vehicles
      const statusResponse = await getCarsStatus(vehicles.map(v => v.registration));
      if (statusResponse && Array.isArray(statusResponse)) {
        vehicles.forEach(vehicle => {
          const status = statusResponse.find(s => s.registration === vehicle.registration);
          if (status && status.location) {
            vehicle.location = {
              lat: status.location.latitude,
              lng: status.location.longitude,
            };

            const marker = new google.maps.Marker({
              position: vehicle.location,
              map,
              title: vehicle.registration,
            });
            markers[vehicle.registration] = marker;
          } else {
            console.warn(`No location data for vehicle ${vehicle.registration}.`);
          }
        });
      } else {
        console.error("Invalid status data received.");
      }
    }

    // Update Map Markers based on selection
    function updateMapMarkers(selectedVehicle) {
      for (let reg in markers) {
        if (reg === selectedVehicle.registration) {
          markers[reg].setVisible(true);
          map.setCenter(markers[reg].getPosition());
          map.setZoom(18); // Street level zoom
        } else {
          markers[reg].setVisible(false);
        }
      }
    }

    // Display Selected Vehicle Details
    function displayVehicleDetails(vehicle) {
      const detailsList = document.getElementById('vehicleDetails');
      detailsList.innerHTML = `
        <li><strong>Registration:</strong> ${vehicle.registration}</li>
        <li><strong>Model:</strong> ${vehicle.model}</li>
        <li><strong>Door Status:</strong> ${vehicle.doorStatus || 'Unavailable'}</li>
        <li><strong>Battery Level:</strong> ${vehicle.batteryLevel || 'Unavailable'}</li>
        <li><strong>System Status:</strong> ${vehicle.systemStatus || 'Unavailable'}</li>
        <li><strong>Last Active Time:</strong> ${vehicle.lastActiveTime || 'Unavailable'}</li>
      `;

      if (vehicle.location) {
        geocoder.geocode({ location: vehicle.location }, (results, status) => {
          if (status === 'OK') {
            if (results[0]) {
              const address = results[0].formatted_address;
              detailsList.innerHTML += `
                <li><strong>Last Known Location:</strong> ${address}</li>
              `;
            } else {
              detailsList.innerHTML += `
                <li><strong>Last Known Location:</strong> No address found</li>
              `;
            }
          } else {
            console.error('Geocoder failed due to: ' + status);
            detailsList.innerHTML += `
              <li><strong>Last Known Location:</strong> ${vehicle.location.lat}, ${vehicle.location.lng}</li>
            `;
          }
        });
      } else {
        detailsList.innerHTML += `
          <li><strong>Last Known Location:</strong> Unavailable</li>
        `;
      }

      document.getElementById('lockButton').disabled = false;
      document.getElementById('unlockButton').disabled = false;
    }

    // Event Listeners for Lock and Unlock Buttons
    document.getElementById('lockButton').addEventListener('click', async () => {
      if (selectedVehicle) {
        await commandCar(selectedVehicle.registration, 'LOCK');
        // Optionally refresh vehicle details
        const status = await getCarStatus(selectedVehicle.registration);
        if (status) {
          selectedVehicle.doorStatus = status.door_status;
          displayVehicleDetails(selectedVehicle);
        }
      }
    });

    document.getElementById('unlockButton').addEventListener('click', async () => {
      if (selectedVehicle) {
        await commandCar(selectedVehicle.registration, 'UNLOCK');
        // Optionally refresh vehicle details
        const status = await getCarStatus(selectedVehicle.registration);
        if (status) {
          selectedVehicle.doorStatus = status.door_status;
          displayVehicleDetails(selectedVehicle);
        }
      }
    });

    // Initialize map and fetch data on page load
    window.onload = () => {
      initMap();
      fetchVehicles();
    };
  </script>
</body>
</html>
